name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc, clang]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Build with Make (${{ matrix.compiler }})
      env:
        CC: ${{ matrix.compiler }}
      run: |
        make clean || true
        make CC=${{ matrix.compiler }}

    - name: Run tests
      run: ./meowpass --test

    - name: Run basic generation
      run: ./meowpass

    - name: Build with CMake
      run: |
        mkdir -p build
        cd build
        cmake ..
        make

    - name: Run CMake build tests
      run: ./build/meowpass --test

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check code style (basic)
      run: |
        # Check for tabs vs spaces consistency
        if grep -r $'\t' src/*.c src/*.h; then
          echo "Warning: Found tabs in source files"
        fi

  debian-package:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake debhelper devscripts

    - name: Build Debian package
      run: |
        dpkg-buildpackage -us -uc -b || echo "Package build attempted"

    - name: Upload Debian package
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: ../*.deb
        if-no-files-found: ignore
